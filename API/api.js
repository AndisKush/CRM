(()=>{var o={347:(o,t,a)=>{const s=a(185).model("Anexo",{pid:String,anexos:Array});o.exports=s},621:(o,t,a)=>{const s=a(185).model("Cliente",{nome:String,cpf:String,telefone:String,ativo:Boolean});o.exports=s},130:(o,t,a)=>{const s=a(185).model("Fluxograma",{nome:String,etapas:Array});o.exports=s},203:(o,t,a)=>{const s=a(185).model("Inversor",{modelo:String,fabricante:String,sistemamonitoramento:String,garantia:Number,tensao:Number,potencia:Number,foto:String,ativo:Boolean});o.exports=s},826:(o,t,a)=>{const s=a(185).model("Kit",{nome:String,modulo:Object,quantidademodulos:Number,potenciacc:Number,inversor:Object,quantidadeinversores:Number,potenciainversor:Number,disjuntorminino:Object,descontomaximo:Number,custogerador:Number,geracaomedia:Array,precovenda:Array,ativo:Boolean});o.exports=s},49:(o,t,a)=>{const s=a(185).model("Log",{usuario:Object,data:Date,acao:Object,colecao:Object,descricao:String,objeto:Object});o.exports=s},714:(o,t,a)=>{const s=a(185).model("Meta",{metas:Object,usuario:Object,produto:Object});o.exports=s},294:(o,t,a)=>{const s=a(185).model("Modulo",{nome:String,modelo:String,potencia:Number,garantiafabrica:Number,garantiaeficiencia:Number,marca:String,peso:Number,foto:String,ativo:Boolean});o.exports=s},473:(o,t,a)=>{const s=a(185).model("OrientacaoTelhado",{nome:String});o.exports=s},829:(o,t,a)=>{const s=a(185).model("PotenciaDisjuntor",{valor:Number});o.exports=s},969:(o,t,a)=>{const s=a(185).model("Produto",{nome:String});o.exports=s},214:(o,t,a)=>{const s=a(185).model("Proposta",{produto:Object,fluxo:Object,etapa:Object,cliente:Object,localinstalacao:Object,orientacaotelhado:Object,disjuntorcliente:Object,faturas:Array,mediaconsumo:Number,mediaconsumoabatida:Number,modulo:Object,kit:Object,topologia:Object,valorkit:Number,desconto:Number,acrescimo:Number,valor:Number,data:Date,user:Object,user2:Object,origem:Object,finalizado:Object,negociacao:Object,responsavel:Object,obs:String,valorprojeto:Number,datainstalacao:Date,quantidadepaineis:Number,dataagendamento:Date,atividades:Array,backlog:Array});o.exports=s},255:(o,t,a)=>{const s=a(185).model("TipoDisjuntor",{nome:String,id:Number});o.exports=s},381:(o,t,a)=>{const s=a(185).model("Usuarios",{nome:String,telefone:String,email:String,password:String,ativo:Boolean,primeirologin:Boolean,supervisor:Boolean});o.exports=s},96:o=>{"use strict";o.exports=require("bcrypt")},582:o=>{"use strict";o.exports=require("cors")},142:o=>{"use strict";o.exports=require("dotenv")},860:o=>{"use strict";o.exports=require("express")},344:o=>{"use strict";o.exports=require("jsonwebtoken")},185:o=>{"use strict";o.exports=require("mongoose")}},t={};function a(s){var r=t[s];if(void 0!==r)return r.exports;var e=t[s]={exports:{}};return o[s](e,e.exports,a),e.exports}(()=>{a(142).config();const o=a(860),t=a(185),s=a(582),r=a(344),e=a(96),n=o();n.use(o.json({limit:"50mb"})),n.use(o.urlencoded({limit:"50mb",extended:!0})),n.use(s()),n.use(((o,t,a)=>{t.header("Access-Control-Allow-Origin","*"),t.header("Access-Control-Allow-Methods","GET, POST, PUT, DELETE"),t.header("Access-Control-Allow-Headers","Content-Type, Authorization"),a()}));const i=a(381),d=a(294),u=a(203),c=a(826),l=a(255),m=a(829),g=a(214),p=a(969),f=a(621),j=a(130),w=a(473),v=a(347),b=a(714),_=a(49);n.get("/",((o,t)=>{t.status(200).json({msg:"LinkApi"})})),n.get("/usuarios",(async(o,t)=>{try{const o=await i.find().select("-password");return t.status(200).json({resultado:o})}catch(o){return console.error("Erro ao buscar módulos:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/usuario",(async(o,t)=>{const{nome:a,telefone:s,email:r,password:n,confirmpassword:d,primeirologin:u,supervisor:c,ativo:l,_id:m}=o.body,g=o.body.user;if(!a)return t.status(422).json({msg:"O nome é obrigatorio"});if(!r)return t.status(422).json({msg:"O email é obrigatorio"});try{if(m){const o=await i.findOne({email:r});return o&&o._id.toString()!==m?t.status(422).json({msg:"Email já cadastrado utilize outro email"}):(await i.updateOne({_id:m},{$set:{nome:a,telefone:s,email:r,ativo:l,supervisor:c,primeirologin:u}})).acknowledged?(await y(g,3,5,`Alterado usuario: ${r}`,o),t.status(200).json({msg:"Registro atualizado com sucesso"})):t.status(500).json({msg:"Erro ao atualizar o módulo"})}{if(!u&&!n)return t.status(422).json({msg:"A senha é obrigatória ou marque primeiro login para definir a senha no primeiro login"});if(!u&&!d)return t.status(422).json({msg:"A confirmação de senha é obrigatória ou marque Primeiro Login para definir a senha no primeiro login"});if(await i.findOne({email:r}))return t.status(422).json({msg:"Email já cadastrado utilize outro email"});var p=null;if(!u){if(n!==d)return t.status(422).json({msg:"Senhas não conferem"});const o=await e.genSalt(12);p=await e.hash(n,o)}const o=new i({nome:a,telefone:s,email:r,password:p||null,primeirologin:u,supervisor:c,ativo:l});await o.save(),await y(g,2,5,`Inserido usuario: ${r}`,o),t.status(200).json({msg:"Usuario criado com sucesso"})}}catch(o){console.log(o),t.status(500).json({msg:"Aconteceu um erro no servidor"})}}));const y=async(o,t,a,s,r)=>{const e={usuario:o,data:new Date,acao:[{id:0,nome:"Outras"},{id:1,nome:"Login"},{id:2,nome:"Inclusão"},{id:3,nome:"Alteração"}][t],colecao:[{id:0,nome:"Outras"},{id:1,nome:"Produtos"},{id:2,nome:"Kits"},{id:3,nome:"Clientes"},{id:4,nome:"Propostas"},{id:5,nome:"Usuarios"},{id:6,nome:"Metas"}][a],descricao:s,objeto:r},n=new _(e);await n.save()};function h(o,t,a){const s=o.headers.authorization,e=s&&s.split(" ")[1];if(!e)return t.status(401).json({msg:"Acesso Negado"});try{const o=process.env.SECRET;r.verify(e,o),a()}catch(o){t.status(400).json({msg:"Sessão Expirada - Faça o Login Novamente"})}}n.post("/auth/primeirologin",(async(o,t)=>{const{email:a,password:s,confirmpassword:n}=o.body;if(!a)return t.status(422).json({msg:"O email é obrigatorio"});if(!s)return t.status(422).json({msg:"A senha é obrigatoria"});if(!n)return t.status(422).json({msg:"A senha é obrigatoria"});if(s!==n)return t.status(422).json({msg:"As senhas precisam ser iguais"});const d=await i.findOne({email:a});if(!d||!d.ativo)return t.status(422).json({msg:"Usuário não encontrado"});if(!d.primeirologin)return t.status(422).json({msg:"Solicite primeiro a alteração de senha"});const u=await e.genSalt(12),c=await e.hash(s,u);try{await i.findByIdAndUpdate(d._id,{password:c,primeirologin:!1}),await d.save()}catch(o){t.status(500).send(o)}try{const o=process.env.SECRET,a=604800,s=r.sign({id:d._id},o,{expiresIn:a});t.status(200).json({msg:"Logado com sucesso",token:s,id:d._id})}catch(o){console.log(o),t.status(500).json({msg:"Aconteceu um erro no servidor"})}})),n.post("/auth/login",(async(o,t)=>{const{email:a,password:s}=o.body;if(!a)return t.status(422).json({msg:"O email é obrigatorio"});if(!s)return t.status(422).json({msg:"A senha é obrigatoria"});const n=await i.findOne({email:a});if(!n)return t.status(404).json({msg:"Usuário não encontrado"});if(!n.ativo)return t.status(404).json({msg:"Usuário inativo"});if(n.primeirologin)return t.status(404).json({msg:"Usuário sem senha, marque a opção primeiro login para definir sua senha"});if(!await e.compare(s,n.password))return t.status(422).json({msg:"Senha inválida"});try{const o=process.env.SECRET,a=604800,s=r.sign({id:n._id},o,{expiresIn:a});t.status(200).json({msg:"Logado com sucesso",token:s,id:n._id})}catch(o){console.log(o),t.status(500).json({msg:"Aconteceu um erro no servidor"})}})),n.get("/user/:id",h,(async(o,t)=>{const a=o.params.id,s=await i.findById(a,"-password");if(!s)return t.status(404).json({msg:"Usuário não encontrado"});const r={...s._doc};return r._id=r._id.toString(),await y(r,1,0,"Realizado login"),t.status(200).json({user:s})})),n.post("/validateuser",h,(async(o,t)=>{const a=o.body,s=await i.findById(a._id,"-password");return s?s.ativo?s.email!==a.email?t.status(400).json({msg:"Usuário não encontrado"}):t.status(200).json({usuario:s}):t.status(400).json({msg:"Usuário não encontrado"}):t.status(404).json({msg:"Usuário não encontrado"})})),n.post("/modulos",h,(async(o,t)=>{const a=o.body,s={ativo:!0};a.ativo&&a.ativo.length>1&&(s.ativo={$in:a.ativo.map((o=>o))});try{const o=await d.find(s);return t.status(200).json({resultado:o})}catch(o){return console.error("Erro ao buscar módulos:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/modulo",(async(o,t)=>{try{const a=o.body,s=o.body.user;if(a._id){const o=await d.findOne({_id:a._id});if((await d.updateOne({_id:a._id},{$set:a})).acknowledged){await c.updateMany({"modulo._id":a._id},{$set:{modulo:a}});const{foto:r,...e}=o._doc;return await y(s,3,1,`Alterado módulo: ${a.modelo}`,e),t.status(200).json({msg:"Registro atualizado com sucesso"})}return t.status(500).json({msg:"Erro ao atualizar o módulo"})}{const o=new d(a);await o.save();const{foto:r,...e}=a;return await y(s,2,1,`Inserido módulo: ${a.modelo}`,e),t.status(200).json({msg:"Registro inserido com sucesso"})}}catch(o){return console.error("Erro ao inserir ou atualizar o módulo:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/unomodulo",(async(o,t)=>{const a=o.body,s={};a._id&&(s._id=a._id);try{const o=await d.findOne(s);return t.status(200).json({resultado:o})}catch(o){return console.error("Erro ao buscar módulos:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/unoinversor",(async(o,t)=>{const a=o.body,s={};a._id&&(s._id=a._id);try{const o=await u.findOne(s);return t.status(200).json({resultado:o})}catch(o){return console.error("Erro ao buscar módulos:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/inversores",(async(o,t)=>{const a=o.body,s={ativo:!0};a.ativo&&a.ativo.length>1&&(s.ativo={$in:a.ativo.map((o=>o))});try{const o=await u.find(s);return t.status(200).json({resultado:o})}catch(o){return console.error("Erro ao buscar módulos:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/inversor",(async(o,t)=>{try{const a=o.body,s=o.body.user;if(a._id){const o=await u.findOne({_id:a._id});if((await u.updateOne({_id:a._id},{$set:a})).acknowledged){await c.updateMany({"inversor._id":a._id},{$set:{inversor:a}});const{foto:r,...e}=o._doc;return await y(s,3,1,`Alterado inversor: ${a.modelo}`,e),t.status(200).json({msg:"Registro atualizado com sucesso"})}return t.status(500).json({msg:"Erro ao atualizar o registro"})}{const o=new u(a);await o.save();const{foto:r,...e}=a;return await y(s,2,1,`Inserido inversor: ${a.modelo}`,e),t.status(200).json({msg:"Registro inserido com sucesso"})}}catch(o){return console.error("Erro ao inserir ou atualizar o registro:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/kits",(async(o,t)=>{const a=o.body,s={ativo:!0};a.ativo&&a.ativo.length>1&&(s.ativo={$in:a.ativo.map((o=>o))});try{const o=await c.find(s).select("-modulo.foto");return t.status(200).json({resultado:o})}catch(o){return console.error("Erro ao buscar módulos:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/kit",(async(o,t)=>{try{const a=o.body,s=o.body.user;if(a._id){const o=await c.findOne({_id:a._id});return delete o.modulo.foto,delete o.inversor.foto,(await c.updateOne({_id:a._id},{$set:a})).acknowledged?(await y(s,3,2,`Alterado kit: ${a.nome}`,o),t.status(200).json({msg:"Registro atualizado com sucesso"})):t.status(500).json({msg:"Erro ao atualizar o registro"})}{const o=new c(a);await o.save();const r={...a};return delete r.modulo.foto,delete r.inversor.foto,await y(s,2,2,`Inserido kit: ${a.nome}`,r),t.status(200).json({msg:"Registro inserido com sucesso"})}}catch(o){return console.error("Erro ao inserir ou atualizar o registro:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.get("/tipodisjuntores",(async(o,t)=>{try{const o=await l.find();return t.status(200).json({resultado:o})}catch(o){return console.error("Erro ao buscar módulos:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.get("/potenciadisjuntores",(async(o,t)=>{try{const o=await m.find().sort({valor:1});return t.status(200).json({resultado:o})}catch(o){return console.error("Erro ao buscar módulos:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/propostas",(async(o,t)=>{const a=o.body;try{let o={};if(a.usuario&&a.usuario._id&&(o["user._id"]=a.usuario._id),a.datainicial&&a.datafinal){const t=new Date(a.datainicial);t.setHours(0,0,0,0);const s=new Date(a.datafinal);s.setHours(23,59,59,999),o.data={$gte:t,$lte:s}}a.cliente&&a.cliente._id&&(o["cliente._id"]=a.cliente._id),a.estado&&a.estado.id&&(o["localinstalacao.estado.id"]=a.estado.id),a.cidade&&a.cidade.id&&(o["localinstalacao.cidade.id"]=a.cidade.id),a.status&&a.status.nome&&(o["finalizado.nome"]=a.status.nome),a.fluxo&&a.fluxo._id&&(o["fluxo.id"]=a.fluxo.id),a.etapa&&a.etapa.id&&(o["etapa.id"]=a.etapa.id),a.responsavel&&a.responsavel._id&&(o["responsavel._id"]=a.responsavel._id);const s=await g.find(o);return t.status(200).json({resultado:s})}catch(o){return console.error("Erro ao buscar propostas:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/lightpropostas",(async(o,t)=>{const a=o.body;try{let o={};if(a.usuario&&a.usuario._id&&(o.$or=[{"user._id":a.usuario._id},{"user2._id":a.usuario._id}]),a.datainicial&&a.datafinal){const t=new Date(a.datainicial);t.setHours(0,0,0,0);const s=new Date(a.datafinal);s.setHours(23,59,59,999),o.data={$gte:t,$lte:s}}a.cliente&&a.cliente._id&&(o["cliente._id"]=a.cliente._id),a.estado&&a.estado.id&&(o["localinstalacao.estado.id"]=a.estado.id),a.cidade&&a.cidade.id&&(o["localinstalacao.cidade.id"]=a.cidade.id),a.status&&a.status.nome&&(o["finalizado.nome"]=a.status.nome),a.fluxo&&a.fluxo._id&&(o["fluxo.id"]=a.fluxo.id),a.etapa&&a.etapa.id&&(o["etapa.id"]=a.etapa.id),a.responsavel&&a.responsavel._id&&(o["responsavel._id"]=a.responsavel._id),a.origem&&a.origem.nome&&(o["origem.nome"]=a.origem.nome);const s=await g.find(o).select("_id cliente produto data valor fluxo etapa");return t.status(200).json({resultado:s})}catch(o){return console.error("Erro ao buscar propostas:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/proposta",(async(o,t)=>{const a=o.body.userLogado;try{let s,r;if(o.body.dado2?(s=o.body.dado1,r=o.body.dado2):s=o.body,s._id){const o=await g.findOne({_id:s._id});return delete o.kit?.modulo?.foto,delete o.kit?.inversor?.foto,delete o.modulo?.foto,(await g.updateOne({_id:s._id},{$set:s})).acknowledged?(await y(a,3,4,`Alterado proposta: ${s.cliente.nome}, Data: ${new Date(s.data).toLocaleDateString()}`,o),t.status(200).json({msg:"Registro atualizado com sucesso"})):t.status(500).json({msg:"Erro ao atualizar o registro"})}{const o=new g(s),e=await o.save(),n=new v({...r,pid:e._id});await n.save();const i={...s};return delete i.kit.modulo.foto,delete i.kit.inversor.foto,delete i.modulo.foto,await y(a,2,4,`Inserido proposta: Cliente: ${e.cliente.nome}, Data: ${new Date(e.data).toLocaleDateString()}`,i),t.status(200).json({msg:"Registro inserido com sucesso"})}}catch(o){return console.error("Erro ao inserir ou atualizar o registro:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/unoproposta",(async(o,t)=>{const a=o.body,s={};a._id&&(s._id=a._id);try{const o=await g.findOne(s);return t.status(200).json({resultado:o})}catch(o){return console.error("Erro ao buscar módulos:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.get("/produtos",(async(o,t)=>{try{const o=await p.find();return t.status(200).json({resultado:o})}catch(o){return console.error("Erro ao buscar módulos:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/clientes",(async(o,t)=>{const a=o.body,s={ativo:!0};a.ativo&&a.ativo.length>1&&(s.ativo={$in:a.ativo.map((o=>o))});try{const o=await f.find(s).sort({nome:1});return t.status(200).json({resultado:o})}catch(o){return console.error("Erro ao buscar módulos:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/cliente",(async(o,t)=>{try{const a=o.body,s=o.body.user,r=await f.findOne({cpf:a.cpf});if(r&&(!a._id||r._id.toString()!==a._id))return t.status(400).json({msg:`CPF já está em uso para o cliente: ${r.nome}`});if(a._id){const o=await f.findOne({_id:a._id});return(await f.updateOne({_id:a._id},{$set:a})).acknowledged?(await y(s,3,3,`Alterado cliente: ${a.nome}`,o),t.status(200).json({msg:"Registro atualizado com sucesso"})):t.status(500).json({msg:"Erro ao atualizar o registro"})}{const o=new f(a),r=await o.save();await y(s,2,3,`Inserido cliente: ${a.nome}`,a);const e=r._id;return t.status(200).json({msg:"Registro inserido com sucesso",_id:e})}}catch(o){return console.error("Erro ao inserir ou atualizar o registro:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.get("/fluxogramas",(async(o,t)=>{try{const o=await j.find();return t.status(200).json({resultado:o})}catch(o){return console.error("Erro ao buscar módulos:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/mensagem",(async(o,t)=>{try{const a=o.body.fluxo,s=o.body.etapa,r=[...(await j.find({id:a.id}))[0].etapas];return r[s.index]=s,(await j.updateOne({_id:a._id},{$set:{etapas:r}})).acknowledged?t.status(200).json({msg:"Registro atualizado com sucesso"}):t.status(500).json({msg:"Erro ao atualizar a mensagem"})}catch(o){return console.error("Erro ao inserir ou atualizar a mensagem:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.get("/orientacaotelhados",(async(o,t)=>{try{const o=await w.find();return t.status(200).json({resultado:o})}catch(o){return console.error("Erro ao buscar módulos:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/anexos",(async(o,t)=>{try{const a=o.body,s=await v.findOne({pid:a._id},{"anexos.base64":0});return t.status(200).json({resultado:s})}catch(o){return console.error("Erro ao buscar módulos:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/getunoanexo",(async(o,t)=>{try{const a=o.body,s=await v.findOne({_id:a._id});if(s.anexos[a.index])return t.status(200).json(s.anexos[a.index])}catch(o){return console.error("Erro ao buscar módulos:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/deleteunoanexo",(async(o,t)=>{try{const a=o.body,s=await v.findOne({_id:a._id});return s?a.index>=0&&a.index<s.anexos.length?(s.anexos.splice(a.index,1),await s.save(),t.status(200).json({message:"Anexo excluído com sucesso"})):t.status(400).json({error:"Índice inválido"}):t.status(404).json({error:"Documento não encontrado"})}catch(o){return console.error("Erro ao excluir anexo:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/anexo",(async(o,t)=>{try{const a=o.body;if(a._id){const o=a.anexos.filter((o=>o.base64)),s=a.anexos.filter((o=>o.alterado));if((await v.updateOne({_id:a._id},{$addToSet:{anexos:{$each:o}}})).acknowledged){for(const o of s)await v.updateOne({_id:a._id,"anexos._id":o._id},{$set:{"anexos.$.nome":o.nome}});return t.status(200).json({msg:"Registro atualizado com sucesso"})}return t.status(500).json({msg:"Erro ao atualizar o registro"})}{const o=new v(a);return await o.save(),t.status(200).json({msg:"Registro inserido com sucesso"})}}catch(o){return console.error("Erro ao inserir ou atualizar o registro:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/metas",(async(o,t)=>{const a=o.body;if(a.usuario&&a.produto)try{const o=await b.findOne({"usuario._id":a.usuario._id,"produto._id":a.produto._id});return t.status(200).json({resultado:o})}catch(o){return console.error("Erro ao buscar módulos:",o),t.status(500).json({error:"Erro interno do servidor"})}return t.status(404).json({error:"Informe os filtros"})})),n.post("/meta",(async(o,t)=>{try{const a=o.body,s=o.body.user,r=await b.findOne({"usuario._id":a.usuario._id,"produto._id":a.produto._id});if(r)return(await b.updateOne({_id:r._id},{$set:a})).acknowledged?(await y(s,3,6,`Alterado meta: ${a.usuario.nome}`,r),t.status(200).json({msg:"Registro atualizado com sucesso"})):t.status(500).json({msg:"Erro ao atualizar o registro"});{const o=new b(a);return await o.save(),await y(s,2,6,`Inserido meta: ${a.usuario.nome}`,a),t.status(200).json({msg:"Registro inserido com sucesso"})}}catch(o){return console.error("Erro ao inserir ou atualizar o registro:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/dadoshome",(async(o,t)=>{const a=o.body,s=new Date(a.datainicial);s.setHours(0,0,0,0);const r=new Date(a.datafinal);r.setHours(23,59,59,999);const e={},n={};if(n.data={$gte:s,$lte:r},n["finalizado.nome"]={$ne:"Rejeitado"},a.usuarios&&a.usuarios.length>0){const o=a.usuarios.map((o=>o._id));n.$or=[{"user._id":{$in:o}},{"user2._id":{$in:o}}]}a.cliente&&a.cliente._id&&(n["cliente._id"]=a.cliente._id),a.estado&&a.estado.id&&(n["localinstalacao.estado.id"]=a.estado.id),a.cidade&&a.cidade.id&&(n["localinstalacao.cidade.id"]=a.cidade.id),a.produtos&&a.produtos.length>0&&(n["produto._id"]={$in:a.produtos.map((o=>o._id))}),a.origem&&a.origem.nome&&(n["origem.nome"]=a.origem.nome);const i={...n},d={...n};d.backlog={$elemMatch:{etapas:{$elemMatch:{nome:{$in:["Assinar Contrato","Fechamento"]}}}}};const u={...d},c=(new Date).getFullYear();u.data={$gte:new Date(c,0,1),$lte:new Date(c,11,31)};const l={};n["user._id"]&&(l["usuario._id"]=n["user._id"]),n["produto._id"]&&(l["produto._id"]=n["produto._id"]);const m={...n};m["finalizado.nome"]={$in:["Aprovado","Finalizado"]};const p={...m};p.data={$gte:new Date(c,0,1),$lte:new Date(c,11,31)};const f={...n};f["finalizado.nome"]={$in:["Rejeitado"]};const j=await g.find(i),w=await g.find(d),v=await g.find(u),_=await g.find(m),y=await g.find(p),h=await g.find(f),$={};j.forEach((o=>{const t=o.fluxo.nome;$[t]||($[t]=0),$[t]+=1}));const E=Array(12).fill(0);v.forEach((o=>{const t=new Date(o.data).getMonth();E[t]+=o.valor}));const x=await b.find(l),O=Array(12).fill(0);x.forEach((o=>{o.metas.valor.map(((o,t)=>{O[t]+=o}))}));const A=await g.aggregate([{$match:d},{$group:{_id:"$produto.nome",totalValor:{$sum:"$valor"}}},{$project:{_id:0,label:"$_id",value:"$totalValor"}}]),S=Array(12).fill(0);y.forEach((o=>{const t=new Date(o.data).getMonth();S[t]+=1}));const z=await b.find(l),D=Array(12).fill(0);z.forEach((o=>{o.metas.quantidade?.map(((o,t)=>{D[t]+=o}))}));const k=await g.aggregate([{$match:m},{$group:{_id:"$produto.nome",quantidade:{$sum:1}}},{$project:{_id:0,label:"$_id",value:"$quantidade"}}]),N=await g.aggregate([{$match:d},{$group:{_id:"$localinstalacao.cidade.nome",totalValor:{$sum:"$valor"}}},{$sort:{totalValor:-1}},{$limit:10},{$project:{_id:0,label:"$_id",value:"$totalValor"}}]),R=await g.aggregate([{$match:d},{$group:{_id:"$localinstalacao.estado.sigla",totalValor:{$sum:"$valor"}}},{$project:{_id:0,label:"$_id",value:"$totalValor"}}]);return e.propostasFluxo=$,e.propostasMes=E,e.metasValor=O,e.propostasProdutoValor=A,e.propostaMesQuantidade=S,e.metasQuantidade=D,e.propostasProdutoQuantidade=k,e.top10cidades=N,e.propostasEstados=R,e.numeroVendas=w.length,e.totalVendasValor=w.reduce(((o,t)=>o+t.valor),0),e.totalVendasKwp=w.reduce(((o,t)=>o+(t.kit?.potenciacc||0)),0),e.ticketMedioValor=parseFloat((e.totalVendasValor/e.numeroVendas).toFixed(2)),e.ticketMedioKwp=parseFloat((e.totalVendasKwp/e.numeroVendas).toFixed(2)),e.taxaConversao=parseFloat((w.length/_.length*100).toFixed(2)),e.propostasRejeitadas=h.length,t.status(200).json({resultado:e})})),n.post("/ajustedb",(async(o,t)=>{})),n.post("/logs",(async(o,t)=>{const a=o.body;try{let o={};if(a.usuario&&a.usuario._id&&(o["usuario._id"]=a.usuario._id),a.data){const t=new Date(a.data);t.setHours(0,0,0,0);const s=new Date(a.data);s.setHours(23,59,59,999),o.data={$gte:t,$lte:s}}a.acao&&void 0!==a.acao.id&&(o["acao.id"]=a.acao.id),a.colecao&&void 0!==a.colecao.id&&(o["colecao.id"]=a.colecao.id);const s=await _.find(o);return t.status(200).json({resultado:s})}catch(o){return console.error("Erro ao buscar propostas:",o),t.status(500).json({error:"Erro interno do servidor"})}})),t.connect("mongodb://127.0.0.1:27017/arasol").then((()=>{console.log("BANCO OK"),n.listen(5001),console.log("API ONLINE")})).catch((o=>console.log(o)))})()})();