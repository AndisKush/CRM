(()=>{var o={347:(o,t,r)=>{const s=r(185).model("Anexo",{pid:String,anexos:Array});o.exports=s},621:(o,t,r)=>{const s=r(185).model("Cliente",{nome:String,cpf:String,telefone:String});o.exports=s},130:(o,t,r)=>{const s=r(185).model("Fluxograma",{nome:String,etapas:Array});o.exports=s},203:(o,t,r)=>{const s=r(185).model("Inversor",{modelo:String,fabricante:String,sistemamonitoramento:String,garantia:Number,tensao:Number,potencia:Number,foto:String});o.exports=s},826:(o,t,r)=>{const s=r(185).model("Kit",{nome:String,modulo:Object,quantidademodulos:Number,potenciacc:Number,inversor:Object,quantidadeinversores:Number,potenciainversor:Number,disjuntorminino:Object,descontomaximo:Number,custogerador:Number,geracaomedia:Array,precovenda:Array});o.exports=s},714:(o,t,r)=>{const s=r(185).model("Meta",{metas:Object,usuario:Object,produto:Object});o.exports=s},294:(o,t,r)=>{const s=r(185).model("Modulo",{nome:String,modelo:String,potencia:Number,garantiafabrica:Number,garantiaeficiencia:Number,marca:String,peso:Number,foto:String});o.exports=s},473:(o,t,r)=>{const s=r(185).model("OrientacaoTelhado",{nome:String});o.exports=s},829:(o,t,r)=>{const s=r(185).model("PotenciaDisjuntor",{valor:Number});o.exports=s},969:(o,t,r)=>{const s=r(185).model("Produto",{nome:String});o.exports=s},214:(o,t,r)=>{const s=r(185).model("Proposta",{produto:Object,fluxo:Object,etapa:Object,cliente:Object,localinstalacao:Object,orientacaotelhado:Object,disjuntorcliente:Object,faturas:Array,mediaconsumo:Number,mediaconsumoabatida:Number,modulo:Object,kit:Object,valorkit:Number,desconto:Number,acrescimo:Number,valor:Number,data:Date,user:Object,origem:Object,finalizado:Object,negociacao:Object,valorprojeto:Number,datainstalacao:Date,quantidadepaineis:Number,dataagendamento:Date,atividades:Array,backlog:Array});o.exports=s},255:(o,t,r)=>{const s=r(185).model("TipoDisjuntor",{nome:String,id:Number});o.exports=s},381:(o,t,r)=>{const s=r(185).model("Usuarios",{nome:String,telefone:String,email:String,password:String,ativo:Boolean,primeirologin:Boolean,supervisor:Boolean});o.exports=s},96:o=>{"use strict";o.exports=require("bcrypt")},582:o=>{"use strict";o.exports=require("cors")},142:o=>{"use strict";o.exports=require("dotenv")},860:o=>{"use strict";o.exports=require("express")},344:o=>{"use strict";o.exports=require("jsonwebtoken")},185:o=>{"use strict";o.exports=require("mongoose")}},t={};function r(s){var a=t[s];if(void 0!==a)return a.exports;var e=t[s]={exports:{}};return o[s](e,e.exports,r),e.exports}(()=>{r(142).config();const o=r(860),t=r(185),s=r(582),a=r(344),e=r(96),n=o();n.use(o.json({limit:"50mb"})),n.use(o.urlencoded({limit:"50mb",extended:!0})),n.use(s()),n.use(((o,t,r)=>{t.header("Access-Control-Allow-Origin","*"),t.header("Access-Control-Allow-Methods","GET, POST, PUT, DELETE"),t.header("Access-Control-Allow-Headers","Content-Type, Authorization"),r()}));const i=r(381),d=r(294),u=r(203),c=r(826),l=r(255),m=r(829),g=r(214),p=r(969),j=r(621),f=r(130),w=r(473),b=r(347),y=r(714);function v(o,t,r){const s=o.headers.authorization,e=s&&s.split(" ")[1];if(!e)return t.status(401).json({msg:"Acesso Negado"});try{const o=process.env.SECRET;a.verify(e,o),r()}catch(o){t.status(400).json({msg:"Sessão Expirada - Faça o Login Novamente"})}}n.get("/",((o,t)=>{t.status(200).json({msg:"Bem vindo ao kushapi"})})),n.get("/usuarios",(async(o,t)=>{try{const o=await i.find().select("-password");return t.status(200).json({resultado:o})}catch(o){return console.error("Erro ao buscar módulos:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/usuario",(async(o,t)=>{const{nome:r,telefone:s,email:a,password:n,confirmpassword:d,primeirologin:u,supervisor:c,ativo:l,_id:m}=o.body;if(!r)return t.status(422).json({msg:"O nome é obrigatorio"});if(!a)return t.status(422).json({msg:"O email é obrigatorio"});try{if(m){const o=await i.findOne({email:a});return o&&o._id.toString()!==m?t.status(422).json({msg:"Email já cadastrado utilize outro email"}):(await i.updateOne({_id:m},{$set:{nome:r,telefone:s,email:a,ativo:l,supervisor:c,primeirologin:u}})).acknowledged?t.status(200).json({msg:"Registro atualizado com sucesso"}):t.status(500).json({msg:"Erro ao atualizar o módulo"})}{if(!u&&!n)return t.status(422).json({msg:"A senha é obrigatória ou marque primeiro login para definir a senha no primeiro login"});if(!u&&!d)return t.status(422).json({msg:"A confirmação de senha é obrigatória ou marque Primeiro Login para definir a senha no primeiro login"});if(await i.findOne({email:a}))return t.status(422).json({msg:"Email já cadastrado utilize outro email"});var g=null;if(!u){if(n!==d)return t.status(422).json({msg:"Senhas não conferem"});const o=await e.genSalt(12);g=await e.hash(n,o)}const o=new i({nome:r,telefone:s,email:a,password:g||null,primeirologin:u,supervisor:c,ativo:l});await o.save(),t.status(200).json({msg:"Usuario criado com sucesso"})}}catch(o){console.log(o),t.status(500).json({msg:"Aconteceu um erro no servidor"})}})),n.post("/auth/primeirologin",(async(o,t)=>{const{email:r,password:s,confirmpassword:n}=o.body;if(!r)return t.status(422).json({msg:"O email é obrigatorio"});if(!s)return t.status(422).json({msg:"A senha é obrigatoria"});if(!n)return t.status(422).json({msg:"A senha é obrigatoria"});if(s!==n)return t.status(422).json({msg:"As senhas precisam ser iguais"});const d=await i.findOne({email:r});if(!d||!d.ativo)return t.status(422).json({msg:"Usuário não encontrado"});if(!d.primeirologin)return t.status(422).json({msg:"Solicite primeiro a alteração de senha"});const u=await e.genSalt(12),c=await e.hash(s,u);try{await i.findByIdAndUpdate(d._id,{password:c,primeirologin:!1}),await d.save()}catch(o){t.status(500).send(o)}try{const o=process.env.SECRET,r=604800,s=a.sign({id:d._id},o,{expiresIn:r});t.status(200).json({msg:"Logado com sucesso",token:s,id:d._id})}catch(o){console.log(o),t.status(500).json({msg:"Aconteceu um erro no servidor"})}})),n.post("/auth/login",(async(o,t)=>{const{email:r,password:s}=o.body;if(!r)return t.status(422).json({msg:"O email é obrigatorio"});if(!s)return t.status(422).json({msg:"A senha é obrigatoria"});const n=await i.findOne({email:r});if(!n)return t.status(404).json({msg:"Usuário não encontrado"});if(!n.ativo)return t.status(404).json({msg:"Usuário inativo"});if(n.primeirologin)return t.status(404).json({msg:"Usuário sem senha, marque a opção primeiro login para definir sua senha"});if(!await e.compare(s,n.password))return t.status(422).json({msg:"Senha inválida"});try{const o=process.env.SECRET,r=604800,s=a.sign({id:n._id},o,{expiresIn:r});t.status(200).json({msg:"Logado com sucesso",token:s,id:n._id})}catch(o){console.log(o),t.status(500).json({msg:"Aconteceu um erro no servidor"})}})),n.get("/user/:id",v,(async(o,t)=>{const r=o.params.id,s=await i.findById(r,"-password");return s?t.status(200).json({user:s}):t.status(404).json({msg:"Usuário não encontrado"})})),n.post("/validateuser",v,(async(o,t)=>{const r=o.body,s=await i.findById(r._id,"-password");return s?s.ativo?s.email!==r.email?t.status(400).json({msg:"Usuário não encontrado"}):t.status(200).json({usuario:s}):t.status(400).json({msg:"Usuário não encontrado"}):t.status(404).json({msg:"Usuário não encontrado"})})),n.get("/modulos",(async(o,t)=>{try{const o=await d.find();return t.status(200).json({resultado:o})}catch(o){return console.error("Erro ao buscar módulos:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/modulo",(async(o,t)=>{try{const r=o.body;if(r._id)return(await d.updateOne({_id:r._id},{$set:r})).acknowledged?t.status(200).json({msg:"Registro atualizado com sucesso"}):t.status(500).json({msg:"Erro ao atualizar o módulo"});{const o=new d(r);return await o.save(),t.status(200).json({msg:"Registro inserido com sucesso"})}}catch(o){return console.error("Erro ao inserir ou atualizar o módulo:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.get("/inversores",(async(o,t)=>{try{const o=await u.find();return t.status(200).json({resultado:o})}catch(o){return console.error("Erro ao buscar módulos:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/inversor",(async(o,t)=>{try{const r=o.body;if(r._id)return(await u.updateOne({_id:r._id},{$set:r})).acknowledged?t.status(200).json({msg:"Registro atualizado com sucesso"}):t.status(500).json({msg:"Erro ao atualizar o registro"});{const o=new u(r);return await o.save(),t.status(200).json({msg:"Registro inserido com sucesso"})}}catch(o){return console.error("Erro ao inserir ou atualizar o registro:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.get("/kits",(async(o,t)=>{try{const o=await c.find();return t.status(200).json({resultado:o})}catch(o){return console.error("Erro ao buscar módulos:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/kit",(async(o,t)=>{try{const r=o.body;if(r._id)return(await c.updateOne({_id:r._id},{$set:r})).acknowledged?t.status(200).json({msg:"Registro atualizado com sucesso"}):t.status(500).json({msg:"Erro ao atualizar o registro"});{const o=new c(r);return await o.save(),t.status(200).json({msg:"Registro inserido com sucesso"})}}catch(o){return console.error("Erro ao inserir ou atualizar o registro:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.get("/tipodisjuntores",(async(o,t)=>{try{const o=await l.find();return t.status(200).json({resultado:o})}catch(o){return console.error("Erro ao buscar módulos:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.get("/potenciadisjuntores",(async(o,t)=>{try{const o=await m.find();return t.status(200).json({resultado:o})}catch(o){return console.error("Erro ao buscar módulos:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/propostas",(async(o,t)=>{const r=o.body;try{let o={};if(r.usuario&&r.usuario._id&&(o["user._id"]=r.usuario._id),r.datainicial&&r.datafinal){const t=new Date(r.datainicial);t.setHours(0,0,0,0);const s=new Date(r.datafinal);s.setHours(23,59,59,999),o.data={$gte:t},o.data={$lte:s}}r.cliente&&r.cliente._id&&(o["cliente._id"]=r.cliente._id),r.estado&&r.estado.id&&(o["localinstalacao.estado.id"]=r.estado.id),r.cidade&&r.cidade.id&&(o["localinstalacao.cidade.id"]=r.cidade.id),r.status&&r.status.nome&&(o["finalizado.nome"]=r.status.nome),r.fluxo&&r.fluxo._id&&(o["fluxo.id"]=r.fluxo.id),r.etapa&&r.etapa.id&&(o["etapa.id"]=r.etapa.id);const s=await g.find(o);return t.status(200).json({resultado:s})}catch(o){return console.error("Erro ao buscar propostas:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/proposta",(async(o,t)=>{try{let r,s;if(o.body.dado2?(r=o.body.dado1,s=o.body.dado2):r=o.body,r._id)return(await g.updateOne({_id:r._id},{$set:r})).acknowledged?t.status(200).json({msg:"Registro atualizado com sucesso"}):t.status(500).json({msg:"Erro ao atualizar o registro"});{const o=new g(r),a=await o.save(),e=new b({...s,pid:a._id});return await e.save(),t.status(200).json({msg:"Registro inserido com sucesso"})}}catch(o){return console.error("Erro ao inserir ou atualizar o registro:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.get("/produtos",(async(o,t)=>{try{const o=await p.find();return t.status(200).json({resultado:o})}catch(o){return console.error("Erro ao buscar módulos:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.get("/clientes",(async(o,t)=>{try{const o=await j.find();return t.status(200).json({resultado:o})}catch(o){return console.error("Erro ao buscar módulos:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/cliente",(async(o,t)=>{try{const r=o.body,s=await j.findOne({cpf:r.cpf});if(s&&(!r._id||s._id.toString()!==r._id))return t.status(400).json({msg:`CPF já está em uso para o cliente: ${s.nome}`});if(r._id)return(await j.updateOne({_id:r._id},{$set:r})).acknowledged?t.status(200).json({msg:"Registro atualizado com sucesso"}):t.status(500).json({msg:"Erro ao atualizar o registro"});{const o=new j(r);return await o.save(),t.status(200).json({msg:"Registro inserido com sucesso"})}}catch(o){return console.error("Erro ao inserir ou atualizar o registro:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.get("/fluxogramas",(async(o,t)=>{try{const o=await f.find();return t.status(200).json({resultado:o})}catch(o){return console.error("Erro ao buscar módulos:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/mensagem",(async(o,t)=>{try{const r=o.body.fluxo,s=o.body.etapa,a=[...(await f.find({id:r.id}))[0].etapas];return a[s.index]=s,(await f.updateOne({_id:r._id},{$set:{etapas:a}})).acknowledged?t.status(200).json({msg:"Registro atualizado com sucesso"}):t.status(500).json({msg:"Erro ao atualizar a mensagem"})}catch(o){return console.error("Erro ao inserir ou atualizar a mensagem:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.get("/orientacaotelhados",(async(o,t)=>{try{const o=await w.find();return t.status(200).json({resultado:o})}catch(o){return console.error("Erro ao buscar módulos:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/anexos",(async(o,t)=>{try{const r=o.body,s=await b.findOne({pid:r._id});return t.status(200).json({resultado:s})}catch(o){return console.error("Erro ao buscar módulos:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/anexo",(async(o,t)=>{try{const r=o.body;if(r._id)return(await b.updateOne({_id:r._id},{$set:r})).acknowledged?t.status(200).json({msg:"Registro atualizado com sucesso"}):t.status(500).json({msg:"Erro ao atualizar o registro"});{const o=new b(r);return await o.save(),t.status(200).json({msg:"Registro inserido com sucesso"})}}catch(o){return console.error("Erro ao inserir ou atualizar o registro:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/metas",(async(o,t)=>{const r=o.body;if(r.usuario&&r.produto)try{const o=await y.findOne({"usuario._id":r.usuario._id,"produto._id":r.produto._id});return t.status(200).json({resultado:o})}catch(o){return console.error("Erro ao buscar módulos:",o),t.status(500).json({error:"Erro interno do servidor"})}return t.status(404).json({error:"Informe os filtros"})})),n.post("/meta",(async(o,t)=>{try{const r=o.body,s=await y.findOne({"usuario._id":r.usuario._id,"produto._id":r.produto._id});if(s)return(await y.updateOne({_id:s._id},{$set:r})).acknowledged?t.status(200).json({msg:"Registro atualizado com sucesso"}):t.status(500).json({msg:"Erro ao atualizar o registro"});{const o=new y(r);return await o.save(),t.status(200).json({msg:"Registro inserido com sucesso"})}}catch(o){return console.error("Erro ao inserir ou atualizar o registro:",o),t.status(500).json({error:"Erro interno do servidor"})}})),n.post("/dadoshome",(async(o,t)=>{const r=o.body,s=new Date(r.datainicial);s.setHours(0,0,0,0);const a=new Date(r.datafinal);a.setHours(23,59,59,999);const e={},n={};n.data={$gte:s,$lte:a},n["finalizado.nome"]={$ne:"Rejeitado"},r.usuarios&&r.usuarios.length>0&&(n["user._id"]={$in:r.usuarios.map((o=>o._id))}),r.cliente&&r.cliente._id&&(n["cliente._id"]=r.cliente._id),r.estado&&r.estado.id&&(n["localinstalacao.estado.id"]=r.estado.id),r.cidade&&r.cidade.id&&(n["localinstalacao.cidade.id"]=r.cidade.id),r.produtos&&r.produtos.length>0&&(n["produto._id"]={$in:r.produtos.map((o=>o._id))});const i={...n},d={...n};d.backlog={$elemMatch:{etapas:{$elemMatch:{nome:{$in:["Assinar Contrato","Fechamento"]}}}}};const u={...d},c=(new Date).getFullYear();u.data={$gte:new Date(c,0,1),$lte:new Date(c,11,31)};const l={};n["user._id"]&&(l["usuario._id"]=n["user._id"]),n["produto._id"]&&(l["produto._id"]=n["produto._id"]);const m={...n};m["finalizado.nome"]={$in:["Aprovado","Finalizado"]};const p={...m};p.data={$gte:new Date(c,0,1),$lte:new Date(c,11,31)};const j={...n};j["finalizado.nome"]={$in:["Rejeitado"]};const f=await g.find(i),w=await g.find(d),b=await g.find(u),v=await g.find(m),h=await g.find(p),_=await g.find(j),E={};f.forEach((o=>{const t=o.fluxo.nome;E[t]||(E[t]=0),E[t]+=1}));const $=Array(12).fill(0);b.forEach((o=>{const t=new Date(o.data).getMonth();$[t]+=o.valor}));const x=await y.find(l),O=Array(12).fill(0);x.forEach((o=>{o.metas.valor.map(((o,t)=>{O[t]+=o}))}));const z=await g.aggregate([{$match:d},{$group:{_id:"$produto.nome",totalValor:{$sum:"$valor"}}},{$project:{_id:0,label:"$_id",value:"$totalValor"}}]),S=Array(12).fill(0);h.forEach((o=>{const t=new Date(o.data).getMonth();S[t]+=1}));const A=await y.find(l),N=Array(12).fill(0);A.forEach((o=>{o.metas.quantidade.map(((o,t)=>{N[t]+=o}))}));const k=await g.aggregate([{$match:m},{$group:{_id:"$produto.nome",quantidade:{$sum:1}}},{$project:{_id:0,label:"$_id",value:"$quantidade"}}]),R=await g.aggregate([{$match:d},{$group:{_id:"$localinstalacao.cidade.nome",totalValor:{$sum:"$valor"}}},{$sort:{totalValor:-1}},{$limit:10},{$project:{_id:0,label:"$_id",value:"$totalValor"}}]),V=await g.aggregate([{$match:d},{$group:{_id:"$localinstalacao.estado.sigla",totalValor:{$sum:"$valor"}}},{$project:{_id:0,label:"$_id",value:"$totalValor"}}]);return e.propostasFluxo=E,e.propostasMes=$,e.metasValor=O,e.propostasProdutoValor=z,e.propostaMesQuantidade=S,e.metasQuantidade=N,e.propostasProdutoQuantidade=k,e.top10cidades=R,e.propostasEstados=V,e.numeroVendas=w.length,e.totalVendasValor=w.reduce(((o,t)=>o+t.valor),0),e.totalVendasKwp=w.reduce(((o,t)=>o+(t.kit?.potenciacc||0)),0),e.ticketMedioValor=parseFloat((e.totalVendasValor/e.numeroVendas).toFixed(2)),e.ticketMedioKwp=parseFloat((e.totalVendasKwp/e.numeroVendas).toFixed(2)),e.taxaConversao=parseFloat((w.length/v.length*100).toFixed(2)),e.propostasRejeitadas=_.length,t.status(200).json({resultado:e})})),n.post("/ajustedb",(async(o,t)=>{c.updateMany({},{$set:{"geracaomedia.0.uf":"GO","geracaomedia.1.uf":"MG","geracaomedia.2.uf":"SP","precovenda.0.uf":"GO","precovenda.1.uf":"MG","precovenda.2.uf":"SP"}}).then((o=>t.status(200).json({result:o}))).catch((o=>{console.error("Erro ao atualizar documentos:",o)}))})),t.connect("mongodb://127.0.0.1:27017/arasol").then((()=>{console.log("BANCO OK"),n.listen(5001),console.log("API ONLINE")})).catch((o=>console.log(o)))})()})();